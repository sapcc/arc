---
platform: linux

image_resource:
  type: docker-image
  source: { repository: hub.***REMOVED***/monsoon/kubectl, tag: 'v1.7.7'}


run:
  path: sh
  args:
    - -ec
    - |
      set -o pipefail
      RS_TO_DELETE=$(kubectl get rs --namespace=$NAMESPACE --sort-by='.metadata.creationTimestamp' --output-version="extensions/v1beta1" -l app=arc-api -ojsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.replicas}{"\n"}{end}' | grep '0$' | cut -f1 | head -n -$KEEP)
      if [ -n "${RS_TO_DELETE}" ]; then
        set -x
        kubectl delete rs --namespace=$NAMESPACE $RS_TO_DELETE
      fi
      set +x
      RS_TO_DELETE=$(kubectl get rs --namespace=$NAMESPACE --sort-by='.metadata.creationTimestamp' --output-version="extensions/v1beta1" -l app=arc-janitor -ojsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.replicas}{"\n"}{end}' | grep '0$' | cut -f1 | head -n -$KEEP)
      if [ -n "${RS_TO_DELETE}" ]; then
        set -x
        kubectl delete rs --namespace=$NAMESPACE $RS_TO_DELETE
      fi

params:
  KEEP: 2
  NAMESPACE: arc
  REGION:
  GITHUB_TOKEN:

