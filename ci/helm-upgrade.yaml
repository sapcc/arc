---
platform: linux

image_resource:
  type: docker-image
  source: { repository: hub.***REMOVED***/monsoon/kubectl, tag: 'v1.4.6'}

inputs:
- name: api.version
- name: mosquitto.version
- name: charts.git
- name: secrets.git

run:
  path: sh
  args:
    - -exc
    - |
      set -o pipefail
      api_version=$(cat api.version/current)
      mosquitto_version=$(cat mosquitto.version/current)
      helm upgrade $RELEASE charts.git/openstack/arc  --values secrets.git/$REGION/values/arc.yaml --set api.image.tag=$api_version,mosquitto.image.tag=$mosquitto_version --debug
      kubectl rollout status deployment/$RELEASE-api --namespace=$NAMESPACE
      kubectl rollout status deployment/mosquitto --namespace=$NAMESPACE
      set +x
      for deployment in $RELEASE-api mosquitto; do
        echo "Waiting for $deployment deployment to succeed"
        until kubectl get deployment $deployment  --namespace=$NAMESPACE -o json | \
                jq -e '.status | .unavailableReplicas == null and .replicas == .updatedReplicas' >/dev/null; do
          if [ $TIMEOUT -le 0 ]; then echo -e "\nTimeout waiting for deployment"; exit 1; fi 
          TIMEOUT=$((TIMEOUT-STEP))
          sleep $STEP
          printf .
        done
        echo -e "\n$deployment deployment completed"
      done

params:
  STEP: 2
  TIMEOUT: 120
  REGION:
  GITHUB_TOKEN:
  HELM_HOST:
  NAMESPACE: arc
  RELEASE: arc
