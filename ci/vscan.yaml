---
platform: 'linux'
image_resource:
  type: docker-image
  source:
    repository: hub.***REMOVED***/monsoon/klar
    tag: 2.3.0
inputs:
  - name: image.version
run:
  path: /bin/bash
  args:
    - -c
    - |
      set -e
      export TZ=UTC
      set -uo pipefail

      if [ "$DOCKER_LOGIN_USERNAME" != "" ] && [ "$DOCKER_LOGIN_PASSWORD" != "" ]; then
        export DOCKER_USER="$DOCKER_LOGIN_USERNAME"
        export DOCKER_PASSWORD="$DOCKER_LOGIN_PASSWORD"
      fi

      IMAGE_TAG=$(cat image.version/current)
      [ -z "$IMAGE_TAG" ] && IMAGE_TAG=latest
      IMAGE=$IMAGE_NAME:$IMAGE_TAG

      echo "Scanning $IMAGE for vulnerabilities"
      CLAIR_ADDR=$CLAIR_URL CLAIR_OUTPUT=$CLAIR_OUTPUT CLAIR_TIMEOUT=$CLAIR_TIMEOUT /klar $IMAGE
params:
  CLAIR_URL: https://clair.***REMOVED***:443
  CLAIR_OUTPUT: Medium
  CLAIR_TIMEOUT: 5
  IMAGE_NAME:
  DOCKER_LOGIN_USERNAME:
  DOCKER_LOGIN_PASSWORD:
